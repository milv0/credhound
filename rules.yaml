# 탐지 규칙 정의

rules:
  # AWS 액세스 키
  - id: aws_access_key
    name: AWS 액세스 키
    severity: CRITICAL
    description: AWS Access Key 및 Secret Key 탐지
    variable_patterns:
      - "(?i)aws.*key"
      - "(?i)aws.*secret"
      - "(?i)access.*key.*id"
    value_patterns:
      - pattern: "AKIA[0-9A-Z]{16}"
        name: "AWS Access Key ID"
      - pattern: "ASIA[0-9A-Z]{16}"
        name: "AWS Temporary Credentials"
      - pattern: "(?i)aws_secret_access_key\\s*=\\s*[\"']?([A-Za-z0-9/+=]{40})[\"']?"
        name: "AWS Secret Access Key"
    value_exclusions:
      - "AKIAIOSFODNN7EXAMPLE"
      - "AKIAI44QH8DHBEXAMPLE"
      - "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"
      - "EXAMPLE"  # EXAMPLE 키워드 포함된 모든 키 제외
      - "ASIAIOSFODNN7EXAMPLE"
      - "ASIAJEXAMPLEXEG2JICE"
      - "ASIAI44QH8DHBEXAMPLE"

  # Private Keys
  - id: private_key
    name: Private Key
    severity: CRITICAL
    description: RSA, DSA, EC, PGP Private Key 탐지
    value_patterns:
      - pattern: "-----BEGIN (?:RSA |DSA |EC |OPENSSH )?PRIVATE KEY-----"
        name: "Private Key Header"
      - pattern: "-----BEGIN ENCRYPTED PRIVATE KEY-----"
        name: "Encrypted Private Key"
      - pattern: "-----BEGIN PGP PRIVATE KEY BLOCK-----"
        name: "PGP Private Key"

  # GitHub 토큰
  - id: github_token
    name: GitHub 토큰
    severity: HIGH
    description: GitHub Personal Access Token 및 OAuth Token
    variable_patterns:
      - "(?i)github.*token"
      - "(?i)gh.*token"
    value_patterns:
      - pattern: "ghp_[0-9a-zA-Z]{36}"
        name: "GitHub Personal Access Token"
      - pattern: "gho_[0-9a-zA-Z]{36}"
        name: "GitHub OAuth Token"
      - pattern: "ghu_[0-9a-zA-Z]{36}"
        name: "GitHub User Token"
      - pattern: "ghs_[0-9a-zA-Z]{36}"
        name: "GitHub Server Token"
      - pattern: "ghr_[0-9a-zA-Z]{36}"
        name: "GitHub Refresh Token"

  # Slack 토큰
  - id: slack_token
    name: Slack 토큰
    severity: HIGH
    description: Slack API Token 및 Webhook
    variable_patterns:
      - "(?i)slack.*token"
      - "(?i)slack.*webhook"
    value_patterns:
      - pattern: "xox[baprs]-[0-9a-zA-Z]{10,48}"
        name: "Slack Token"
      - pattern: "https://hooks\\.slack\\.com/services/T[a-zA-Z0-9_]{8}/B[a-zA-Z0-9_]{8,10}/[a-zA-Z0-9_]{24}"
        name: "Slack Webhook URL"

  # Google API 키
  - id: google_api_key
    name: Google API 키
    severity: MEDIUM
    description: Google API Key
    variable_patterns:
      - "(?i)google.*api.*key"
      - "(?i)gcp.*key"
    value_patterns:
      - pattern: "AIza[0-9A-Za-z\\-_]{35}"
        name: "Google API Key"

  # JWT 토큰
  - id: jwt_token
    name: JWT 토큰
    severity: MEDIUM
    description: JSON Web Token
    value_patterns:
      - pattern: "eyJ[A-Za-z0-9_-]*\\.eyJ[A-Za-z0-9_-]*\\.[A-Za-z0-9_-]*"
        name: "JWT Token"

  # Generic API 키
  - id: generic_api_key
    name: Generic API 키
    severity: MEDIUM
    description: 일반적인 API Key 패턴
    variable_patterns:
      - "(?i)api[_-]?key"
      - "(?i)api[_-]?secret"
      - "(?i)access[_-]?token"
      - "(?i)auth[_-]?token"
    value_patterns:
      - pattern: "(?i)api[_-]?key\\s*[=:]\\s*[\"']?([0-9a-zA-Z_\\-]{32,})[\"']?"
        name: "API Key Assignment"
      - pattern: "(?i)api[_-]?secret\\s*[=:]\\s*[\"']?([0-9a-zA-Z_\\-]{32,})[\"']?"
        name: "API Secret Assignment"
    value_exclusions:
      - "(?i)^test"
      - "(?i)^example"
      - "(?i)^sample"

  # Database 연결 문자열
  - id: database_connection
    name: Database 연결 문자열
    severity: MEDIUM
    description: Database Connection String
    value_patterns:
      - pattern: "(?i)mongodb(\\+srv)?://[^\\s]+"
        name: "MongoDB Connection String"
      - pattern: "(?i)postgres://[^\\s]+"
        name: "PostgreSQL Connection String"
      - pattern: "(?i)mysql://[^\\s]+"
        name: "MySQL Connection String"
    value_exclusions:
      - "localhost"
      - "127.0.0.1"
      - "postgres:postgres@postgres"

  # Azure 키
  - id: azure_key
    name: Azure 키
    severity: HIGH
    description: Azure Storage 및 Service Key
    variable_patterns:
      - "(?i)azure.*key"
      - "(?i)azure.*connection"
    value_patterns:
      - pattern: "DefaultEndpointsProtocol=https;AccountName=[^;]+;AccountKey=[^;]+"
        name: "Azure Storage Connection String"

  # Stripe 키
  - id: stripe_key
    name: Stripe 키
    severity: HIGH
    description: Stripe API Key
    variable_patterns:
      - "(?i)stripe.*key"
    value_patterns:
      - pattern: "sk_live_[0-9a-zA-Z]{24,}"
        name: "Stripe Secret Key"
      - pattern: "pk_live_[0-9a-zA-Z]{24,}"
        name: "Stripe Publishable Key"
      - pattern: "rk_live_[0-9a-zA-Z]{24,}"
        name: "Stripe Restricted Key"

  # Twilio 키
  - id: twilio_key
    name: Twilio 키
    severity: HIGH
    description: Twilio API Key 및 Account SID
    variable_patterns:
      - "(?i)twilio.*key"
      - "(?i)twilio.*sid"
    value_patterns:
      - pattern: "SK[0-9a-fA-F]{32}"
        name: "Twilio API Key"
      - pattern: "AC[0-9a-fA-F]{32}"
        name: "Twilio Account SID"

  # SendGrid 키
  - id: sendgrid_key
    name: SendGrid 키
    severity: HIGH
    description: SendGrid API Key
    variable_patterns:
      - "(?i)sendgrid.*key"
    value_patterns:
      - pattern: "SG\\.[0-9A-Za-z\\-_]{22}\\.[0-9A-Za-z\\-_]{43}"
        name: "SendGrid API Key"

  # Heroku API 키
  - id: heroku_key
    name: Heroku API 키
    severity: HIGH
    description: Heroku API Key
    variable_patterns:
      - "(?i)heroku.*key"
    value_patterns:
      - pattern: "(?i)heroku[_\\s-]*(?:api[_\\s-]*)?key[\"\\s:=]+([0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12})"
        name: "Heroku API Key"

  # DigitalOcean 토큰
  - id: digitalocean_token
    name: DigitalOcean 토큰
    severity: HIGH
    description: DigitalOcean Personal Access Token
    variable_patterns:
      - "(?i)digitalocean.*token"
      - "(?i)do.*token"
    value_patterns:
      - pattern: "dop_v1_[0-9a-f]{64}"
        name: "DigitalOcean Personal Access Token"
      - pattern: "doo_v1_[0-9a-f]{64}"
        name: "DigitalOcean OAuth Token"

  # 하드코딩된 패스워드
  - id: password_in_code
    name: 하드코딩된 패스워드
    severity: HIGH
    description: 코드 내 하드코딩된 패스워드 탐지
    variable_patterns:
      - "(?i)password"
      - "(?i)passwd"
      - "(?i)pwd"
    value_patterns:
      - pattern: "(?i)password\\s*[=:]\\s*[\"']([^\"']{8,})[\"']"
        name: "Password Assignment"
      - pattern: "(?i)passwd\\s*[=:]\\s*[\"']([^\"']{8,})[\"']"
        name: "Passwd Assignment"
      - pattern: "(?i)pwd\\s*[=:]\\s*[\"']([^\"']{8,})[\"']"
        name: "Pwd Assignment"
    value_exclusions:
      - "placeholder"
      - "example"
      - "test"
      - "changeme"
      - "xxx"
      - "\\*\\*\\*"
      - "password"
      - "123456"

  # NPM 토큰
  - id: npm_token
    name: NPM 토큰
    severity: HIGH
    description: NPM Registry Token
    variable_patterns:
      - "(?i)npm.*token"
    value_patterns:
      - pattern: "//registry\\.npmjs\\.org/:_authToken=[A-Za-z0-9\\-_]+"
        name: "NPM Auth Token"

  # PyPI 토큰
  - id: pypi_token
    name: PyPI 토큰
    severity: HIGH
    description: PyPI API Token
    variable_patterns:
      - "(?i)pypi.*token"
    value_patterns:
      - pattern: "pypi-[A-Za-z0-9_-]{100,}"
        name: "PyPI API Token"

  # Mailgun 키
  - id: mailgun_key
    name: Mailgun 키
    severity: HIGH
    description: Mailgun API Key
    variable_patterns:
      - "(?i)mailgun.*key"
    value_patterns:
      - pattern: "key-[0-9a-zA-Z]{32}"
        name: "Mailgun API Key"

  # Square 토큰
  - id: square_token
    name: Square 토큰
    severity: HIGH
    description: Square API Token
    variable_patterns:
      - "(?i)square.*token"
    value_patterns:
      - pattern: "sq0[a-z]{3}-[0-9A-Za-z\\-_]{22,43}"
        name: "Square API Token"

  # Telegram 봇 토큰
  - id: telegram_bot_token
    name: Telegram 봇 토큰
    severity: MEDIUM
    description: Telegram Bot Token
    variable_patterns:
      - "(?i)telegram.*token"
      - "(?i)bot.*token"
    value_patterns:
      - pattern: "[0-9]{8,10}:[0-9A-Za-z_-]{35}"
        name: "Telegram Bot Token"
    value_exclusions:
      - "aws-controltower"
      - "(?i)arn:"
      - "(?i):aws-"

  # Shopify 토큰
  - id: shopify_token
    name: Shopify 토큰
    severity: HIGH
    description: Shopify API Token
    variable_patterns:
      - "(?i)shopify.*token"
    value_patterns:
      - pattern: "shpat_[a-fA-F0-9]{32}"
        name: "Shopify Private App Token"
      - pattern: "shpss_[a-fA-F0-9]{32}"
        name: "Shopify Shared Secret"

  # GitLab 토큰
  - id: gitlab_token
    name: GitLab 토큰
    severity: HIGH
    description: GitLab Personal Access Token
    variable_patterns:
      - "(?i)gitlab.*token"
    value_patterns:
      - pattern: "glpat-[0-9A-Za-z\\-_]{20}"
        name: "GitLab Personal Access Token"

  # HashiCorp Vault 토큰
  - id: hashicorp_vault_token
    name: HashiCorp Vault 토큰
    severity: CRITICAL
    description: HashiCorp Vault Token
    variable_patterns:
      - "(?i)vault.*token"
    value_patterns:
      - pattern: "hvs\\.[a-zA-Z0-9_-]{24,}"
        name: "Vault Token"

  # GCP 서비스 계정
  - id: gcp_service_account
    name: GCP 서비스 계정
    severity: HIGH
    description: GCP Service Account Key
    value_patterns:
      - pattern: "\"type\":\\s*\"service_account\""
        name: "GCP Service Account JSON"

  # URL 내 패스워드
  - id: generic_password_url
    name: URL 내 패스워드
    severity: HIGH
    description: URL에 포함된 사용자명과 패스워드
    value_patterns:
      - pattern: "://[^\\s/:]+:[^\\s/@]+@[^\\s]+"
        name: "Password in URL"
    value_exclusions:
      - "localhost"
      - "127.0.0.1"
      - "example.com"
      - "user:pass@"
      - "://.*\\.git"
      - "://$"
      - "username:password"
      - "#\\{.*\\}"
      - "://buildertoolbox-"
      - "\"Email\""
      - "\"Team\""
      - "@amazon\\.com"
      - "\\$\\{"
      - "%\\{"

  # AWS 세션 토큰
  - id: aws_session_token
    name: AWS 세션 토큰
    severity: CRITICAL
    description: AWS Session Token
    variable_patterns:
      - "(?i)aws.*session.*token"
    value_patterns:
      - pattern: "(?i)aws_session_token\\s*=\\s*[\"']?([A-Za-z0-9/+=]{100,})[\"']?"
        name: "AWS Session Token"

  # Datadog API 키
  - id: datadog_api_key
    name: Datadog API 키
    severity: HIGH
    description: Datadog API/APP Key
    variable_patterns:
      - "(?i)datadog.*key"
      - "(?i)dd_(?:api|app)_key"
    value_patterns:
      - pattern: "(?i)(?:datadog|dd_api_key|dd_app_key)\\s*[=:]\\s*[\"']?([a-f0-9]{32})[\"']?"
        name: "Datadog Key"

  # Firebase URL
  - id: firebase_url
    name: Firebase URL
    severity: MEDIUM
    description: Firebase Database URL
    value_patterns:
      - pattern: "https://[a-z0-9-]+\\.firebaseio\\.com"
        name: "Firebase Database URL"

  # 암호화 키
  - id: encryption_key
    name: 암호화 키
    severity: HIGH
    description: 하드코딩된 암호화 키
    variable_patterns:
      - "(?i)encrypt.*key"
      - "(?i)secret.*key"
      - "(?i)signing.*key"
    value_patterns:
      - pattern: "(?i)(?:encrypt|secret|signing).*key\\s*[=:]\\s*[\"']?([0-9a-fA-F]{32,})[\"']?"
        name: "Encryption Key"

# 파일명 기반 탐지 패턴
file_patterns:
  - category: AWS 액세스 키
    severity: CRITICAL
    patterns:
      - "\\.aws/credentials$"
      - "\\.aws/config$"
  
  - category: SSH 키
    severity: CRITICAL
    patterns:
      - "\\.ssh/id_rsa$"
      - "\\.ssh/id_ed25519$"
      - "\\.ssh/id_ecdsa$"
      - "\\.ssh/.*\\.pem$"
      - "id_rsa$"
      - "id_ed25519$"
      - "id_ecdsa$"
  
  - category: 인증서/키 파일
    severity: LOW
    patterns:
      - "\\.pem$"
      - "\\.p12$"
      - "\\.pfx$"
      - "\\.cer$"
      - "\\.crt$"
      - "\\.key$"
      - "\\.der$"
      - "\\.csr$"
  
  - category: API 키/토큰
    severity: MEDIUM
    patterns:
      - "\\.env$"
      - "\\.env\\.local$"
      - "\\.env\\.production$"
      - "\\.env\\.staging$"
      - "\\.npmrc$"
      - "\\.pypirc$"
  
  - category: Git 인증
    severity: MEDIUM
    patterns:
      - "\\.git-credentials$"
      - "\\.netrc$"
  
  - category: Docker/Kubernetes
    severity: MEDIUM
    patterns:
      - "\\.docker/config\\.json$"
      - "\\.kube/config$"
  
  - category: GCP 인증
    severity: MEDIUM
    patterns:
      - "\\.config/gcloud/.*\\.json$"
      - ".*service[_-]account.*\\.json$"
  
  - category: Terraform/Infrastructure
    severity: MEDIUM
    patterns:
      - "terraform\\.tfvars$"
      - ".*\\.auto\\.tfvars$"
  
  - category: 설정/비밀 파일
    severity: HIGH
    patterns:
      - "credentials\\.json$"
      - "secrets\\.json$"
      - "secrets\\.yaml$"
      - "\\.htpasswd$"
      - "wp-config\\.php$"